<!-- Map Component -->
<div class="demo-section">
    <h2 class="demo-title">21. Dynamic Map Component</h2>
    <ui-map 
        locations="New York,40.7128,-74.0060;London,51.5074,-0.1278;Tokyo,35.6762,139.6503;Paris,48.8566,2.3522"
        center="40.7128,-74.0060"
        zoom="4"
        height="500px"
        showMarkers="true"
        showRoutes="false"
        routeColor="#FF6B6B"
        markerColor="#4ECDC4"
        theme="light"
        interactive="true">
    </ui-map>
</div>

<style>
/* Map Component Styles */
ui-map {
    display: block;
    width: 100%;
    min-height: 400px;
    border-radius: var(--radius-size);
    box-shadow: var(--shadow-soft);
    transition: all 0.3s var(--animation-smooth);
    overflow: hidden;
    position: relative;
}

ui-map:hover {
    box-shadow: var(--shadow-medium);
    transform: translateY(-2px);
}

ui-map .map-container {
    position: relative;
    width: 100%;
    height: 100%;
    border-radius: var(--radius-size);
    overflow: hidden;
}

/* Leaflet Map Customizations */
ui-map .leaflet-container {
    border-radius: var(--radius-size);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

ui-map .leaflet-popup-content-wrapper {
    border-radius: var(--radius-size);
    box-shadow: var(--shadow-medium);
}

ui-map .leaflet-popup-content {
    margin: 12px;
    font-size: 14px;
    line-height: 1.4;
}

ui-map .leaflet-control-zoom {
    border: none;
    box-shadow: var(--shadow-soft);
}

ui-map .leaflet-control-zoom a {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: var(--color-dark);
    font-weight: bold;
    transition: all 0.3s var(--animation-smooth);
}

ui-map .leaflet-control-zoom a:hover {
    background: rgba(255, 255, 255, 1);
    transform: scale(1.05);
}

ui-map .leaflet-control-fullscreen {
    transition: all 0.3s var(--animation-smooth);
}

ui-map .leaflet-control-fullscreen:hover {
    background: #f8f9fa !important;
    transform: scale(1.05);
}

/* Custom marker styles */
ui-map .custom-marker {
    background: transparent;
    border: none;
}

/* Dark theme adjustments */
ui-map.map-dark .leaflet-control-zoom a {
    background: rgba(44, 62, 80, 0.95);
    color: white;
    border-color: rgba(255, 255, 255, 0.2);
}

ui-map.map-dark .leaflet-control-zoom a:hover {
    background: rgba(44, 62, 80, 1);
}

ui-map.map-dark .leaflet-control-fullscreen:hover {
    background: #34495e !important;
    color: white;
}
</style>

<script>
// Map Component Initialization
function initMaps() {
    console.log('Initializing maps...');
    document.querySelectorAll('ui-map').forEach((map, index) => {
        console.log(`Initializing map ${index + 1}...`);
        
        const locations = map.getAttribute('locations');
        const center = map.getAttribute('center');
        const zoom = parseInt(map.getAttribute('zoom')) || 10;
        const height = map.getAttribute('height') || '400px';
        const showMarkers = map.getAttribute('showMarkers') === 'true';
        const showRoutes = map.getAttribute('showRoutes') === 'true';
        const routeColor = map.getAttribute('routeColor') || '#FF6B6B';
        const markerColor = map.getAttribute('markerColor') || '#4ECDC4';
        const theme = map.getAttribute('theme') || 'light';
        const interactive = map.getAttribute('interactive') === 'true';

        map.className = `map-${theme}`;
        map.style.height = height;

        // Add loading indicator
        const loadingDiv = document.createElement('div');
        loadingDiv.style.cssText = `
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            z-index: 1000;
            font-weight: 500;
            color: #666;
        `;
        loadingDiv.innerHTML = `
            <div style="text-align: center;">
                <div style="font-size: 24px; margin-bottom: 10px;">üó∫Ô∏è</div>
                <div>Loading Map...</div>
            </div>
        `;
        map.appendChild(loadingDiv);

        // Parse locations
        const locationList = locations ? locations.split(';').map(loc => {
            const [name, lat, lng] = loc.split(',');
            return { name: name.trim(), lat: parseFloat(lat), lng: parseFloat(lng) };
        }) : [];

        // Parse center coordinates
        const [centerLat, centerLng] = center ? center.split(',').map(coord => parseFloat(coord)) : [0, 0];

        // Create map container
        const mapContainer = document.createElement('div');
        mapContainer.className = 'map-container';
        mapContainer.id = 'map-' + Math.random().toString(36).substr(2, 9);
        mapContainer.style.cssText = `
            width: 100%;
            height: 100%;
            border-radius: var(--radius-size);
            overflow: hidden;
            position: relative;
        `;

        map.appendChild(mapContainer);

        // Check if Leaflet is available
        if (typeof L !== 'undefined') {
            try {
                initLeafletMap(mapContainer, locationList, centerLat, centerLng, zoom, showMarkers, showRoutes, routeColor, markerColor, theme, interactive);
                loadingDiv.remove();
            } catch (error) {
                console.error('Error initializing Leaflet map:', error);
                loadingDiv.remove();
                createFallbackMap(mapContainer, locationList, centerLat, centerLng, zoom, showMarkers, showRoutes, routeColor, markerColor, theme);
            }
        } else {
            console.warn('Leaflet not available, using fallback map');
            loadingDiv.remove();
            createFallbackMap(mapContainer, locationList, centerLat, centerLng, zoom, showMarkers, showRoutes, routeColor, markerColor, theme);
        }
    });
}

function initLeafletMap(container, locations, centerLat, centerLng, zoom, showMarkers, showRoutes, routeColor, markerColor, theme, interactive) {
    // Use a simple, reliable tile provider
    const tileLayer = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
    const attribution = '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors';

    // Initialize the map
    const map = L.map(container.id, {
        center: [centerLat, centerLng],
        zoom: zoom,
        zoomControl: interactive,
        scrollWheelZoom: interactive,
        dragging: interactive,
        touchZoom: interactive,
        doubleClickZoom: interactive,
        boxZoom: interactive,
        keyboard: interactive
    });

    // Add tile layer
    L.tileLayer(tileLayer, {
        attribution: attribution,
        maxZoom: 19
    }).addTo(map);

    // Store map instance for later use
    container.leafletMap = map;

    // Add markers if enabled
    if (showMarkers && locations.length > 0) {
        locations.forEach(location => {
            // Create custom marker icon
            const markerIcon = L.divIcon({
                className: 'custom-marker',
                html: `<div style="
                    background-color: ${markerColor};
                    width: 20px;
                    height: 20px;
                    border-radius: 50%;
                    border: 3px solid white;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: white;
                    font-weight: bold;
                    font-size: 12px;
                ">üìç</div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            const marker = L.marker([location.lat, location.lng], { icon: markerIcon })
                .addTo(map);

            // Add click-to-zoom functionality
            marker.on('click', function() {
                map.setView([location.lat, location.lng], 12);
            });

            marker.bindPopup(`<b>${location.name}</b><br>${location.lat.toFixed(4)}, ${location.lng.toFixed(4)}`);
        });
    }

    // Add routes if enabled
    if (showRoutes && locations.length > 1) {
        const routePoints = locations.map(loc => [loc.lat, loc.lng]);
        
        // Create a more prominent route with multiple layers
        const shadowRoute = L.polyline(routePoints, {
            color: '#000',
            weight: 14,
            opacity: 0.4
        }).addTo(map);
        
        const mainRoute = L.polyline(routePoints, {
            color: routeColor,
            weight: 10,
            opacity: 1.0
        }).addTo(map);
        
        // Bring the main route to front
        mainRoute.bringToFront();
        
        // Fit map to show all locations
        map.fitBounds(mainRoute.getBounds(), { padding: [20, 20] });
    } else if (locations.length > 0) {
        // Fit map to show all markers
        const bounds = locations.map(loc => [loc.lat, loc.lng]);
        map.fitBounds(bounds, { padding: [20, 20] });
    }
}

function createFallbackMap(container, locations, centerLat, centerLng, zoom, showMarkers, showRoutes, routeColor, markerColor, theme) {
    // Create a simple fallback map using canvas
    const canvas = document.createElement('canvas');
    canvas.width = container.offsetWidth;
    canvas.height = container.offsetHeight;
    canvas.style.cssText = `
        width: 100%;
        height: 100%;
        border-radius: var(--radius-size);
    `;
    
    container.appendChild(canvas);
    
    const ctx = canvas.getContext('2d');
    const width = canvas.width;
    const height = canvas.height;

    // Clear canvas
    ctx.clearRect(0, 0, width, height);

    // Set background
    ctx.fillStyle = theme === 'dark' ? '#2c3e50' : '#f8f9fa';
    ctx.fillRect(0, 0, width, height);

    // Draw grid
    ctx.strokeStyle = theme === 'dark' ? '#34495e' : '#e9ecef';
    ctx.lineWidth = 1;
    for (let i = 0; i < width; i += 50) {
        ctx.beginPath();
        ctx.moveTo(i, 0);
        ctx.lineTo(i, height);
        ctx.stroke();
    }
    for (let i = 0; i < height; i += 50) {
        ctx.beginPath();
        ctx.moveTo(0, i);
        ctx.lineTo(width, i);
        ctx.stroke();
    }

    // Draw markers if enabled
    if (showMarkers) {
        locations.forEach(location => {
            const x = width / 2 + (location.lng - centerLng) * 100 * zoom;
            const y = height / 2 + (location.lat - centerLng) * 100 * zoom;

            // Draw marker
            ctx.fillStyle = markerColor;
            ctx.beginPath();
            ctx.arc(x, y, 8, 0, 2 * Math.PI);
            ctx.fill();

            ctx.strokeStyle = theme === 'dark' ? '#fff' : '#000';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw location name
            ctx.fillStyle = theme === 'dark' ? '#fff' : '#000';
            ctx.font = '12px Inter, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(location.name, x, y - 15);
        });
    }

    // Add fallback message
    const message = document.createElement('div');
    message.style.cssText = `
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
        backdrop-filter: blur(10px);
    `;
    message.textContent = 'Map (Fallback Mode)';
    container.appendChild(message);
}

// Initialize maps when DOM is loaded
document.addEventListener('DOMContentLoaded', initMaps);
</script> 